**IP-계층 보안**은 **인증, 기밀성, 키관리로 구성되어 있다.**

- 인증 메커니즘 = 수신된 패킷이 정말로 패킷 헤더 안에 들어있는 발신지로부터 전송된 것인지를 확인해주는 것
- 기밀성 = 제 3자 도청을 방지하기 위해 통신 노드 간 메시지 암호화
- 키 관리 기능 = 안전하게 키를 교환하기.

IP 보안의 개요와 IPsec의 구조를 소개하고, 세 기능적 분야에 대해 자세히 공부하는 것이 목표!

# IP 보안 개요

[IP 스푸핑](https://ko.wikipedia.org/wiki/IP_%EC%A3%BC%EC%86%8C_%EC%8A%A4%ED%91%B8%ED%95%91), [패킷 스니핑](https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=wnrjsxo&logNo=221115871221)에 대한 문제가 발생.

위와 같은 문제를 해결하기 위해 IAB에선 **IPv6** 에 인증과 암호를 필수로 삽입.

## IPsec의 응용

IPsec은 [LAN](https://codeup.kr/index.php), 사설 및 공공 [WAN](https://ko.wikipedia.org/wiki/%EA%B4%91%EC%97%AD_%ED%86%B5%EC%8B%A0%EB%A7%9D) 그리고 인터넷을 통과하는 통신을 안전하게 만든다.

예시 →

- 인터넷을 통한 안전한 지사 사무실 연결
- 인터넷을 통한 안전한 원격 접근
- 협력업체와의 인트라넷과 엑스트라넷 구축
- 전자 상거래 보안 강화

- IPsec이 위와 같은 여러 응용을 지원할 수 있는 이유는 무엇일까?
  → IPsec이 모든 트래픽에 대한 암호화와 인증을 IP 계층에서 할 수 있는 기능을 갖고 있기 때문.
- IPsec 네트워킹 장치는 일반적으로 WAN으로 나가는 모든 트래픽을 암호화하고 압축하며, WAN으로 들어오는 트래픽을 복호화하고 압축을 푼다.

### IPsec 장점

- IPsec + 침입차단시스템 or 라우터에서 구현할 경우 **영역을 통과하는 모든 트래픽에 적용할 수 있는 강한 보안성을 제공한다.**
- 외부로부터 모든 트래픽이 IP를 사용해야만 한다면 침입차단시스템에서 IPsec은 우회하는 트래픽을 차단할 수 있다. (인터넷으로부터 기관 안으로 들어오는 유일한 경로는 침입차단시스템)
- IPsec은 전송 계층(TCP와 UDP)아래에 있고 응용 프로그램에게 투명하다. 사용자가 시스템의 소프트웨어를 바꿀 필요가 없으며, IPsec은 상위-계층 소프트웨어에 영향을 주지 않는다.
- IPsec은 종단 사용자에게 투명하므로, 보안 메커니즘에 대한 교육이나, 개별 기반 키 발급 , 키를 취소할 필요가 없다.
- 개별 사용자에 대한 보안이 필요할 경우 IPsec이 제공할 수 있다. 안전한 가상 서브네트워크 구성에도 유용하다.

### 라우팅 응용

- 라우터 간 신뢰를 보장해줌.

### IPsec 서비스

- IPsec이 IP계층에 어떻게 서비스를 제공하는가 ?
  - 요구된 보안 프로토콜을 선택
  - 서비스에 필요한 알고리즘 결정
  - 요구된 서비스에 필요한 암호키 설정.
- 보안에 사용되는 프로토콜은 무엇이 있을까?
  - 인증 프로토콜(AH - Authentication Header)
  - 암호화와 인증이 결합된 프로토콜 (ESP - Encapsulating Security Payload)
    → 주로 ESP 사용. 인증 + 암호화
- 데이터에 대한 기밀성과 무결성을 제공한다.

### 전송 모드와 터널 모드

- AH와 ESP는 터널 모드를 지원함.

  - 전송 모드 (차에 선팅을 해서 안에 누가 탔는지 안보이게 함.)
    - 상위 계층 프로토콜 보호(전달하는 데이터만 보호)
  - 터널모드 (터널을 만들어서 차가 지나가는 것도 모르게 함.)
    - IP 패킷 전체 보호

- 전송모드
  - IP 패킷의 페이로드 범위까지 보호
    - TCP 단편
    - UDP 단편
    - ICMP 패킷
  - 호스트 프로토콜 계층의 IP 위에서 직접 동작
  - 두 호스트 사이의 종단 - 대 - 종단 통신에 전송 모드를 이용함.
  - ESP
    - IP 페이로드를 암호화.
    - 인증은 선택사항 (전달하는 내용만 보호하는 것이 목적이므로 헤더는 보호하지 않음)
  - AH
    - IP 페이로드와 IP 헤더의 선별된 일부만 인증
- 터널 모드
  - IP 패킷을 전부 보호
    - AH 또는 ESP 필드에 IP 패킷 추가 ⇒ 전체 패킷
  - 전체 패킷과 보안필드를 합쳐서 새 외부 IP 헤더를 가진 새로운 "외부" IP 패킷의 페이로드로 간주함.
  - 원래 전체 패킷 or 내부 패킷은 "터널"로 이동
  - 호스트 간의 정보교환 == 네트워크 장비들 간의 정보교환으로 볼 수 있다.(터널 모드에서는!)
    → 터널 모드 IPsec 작동 예시
    ![0](https://user-images.githubusercontent.com/78394999/144238735-fa70b690-55e7-44b6-8e8c-3366b4b447ca.png)

### 보안 연관

- 트래픽에 보안서비스를 제공하는 송신자와 수신자 사이의 일방향 관계 → 일종의 연결 상태
- 양방향에서 교신을 대등하게 하려면 두 개의 보안 연관이 필요하다. → 보안 연관 서비스가 다를 경우 다른 키를 사용해야 한다.
- AH 나 ESP(두 개 동시사용은 안 됨)를 사용하기 위해 SA에 보안 서비스를 제공한다.

### 보안 연관 식별 매개변수 (어떤 연결 상태이고, 무엇으로 연결되어 있는가를 나타내는 매개변수)

- 보안 매개변수 색인
- IP 목적지 주소
- 보안 프로토콜 식별자

### 보안 연관 데이터베이스(SPI)

- 네트워크 장비 입장에선 매우 다양한 연관이 있을 것이다. 다양한 연관을 정리한 DB이다.

### 보안 정책 데이터베이스(SPD) (IP 트래픽을 어떠한 특정 sa와 연관시키기 위한 정보)

- IP 트래픽을 특정 SA에 연관시키는 방법 (IPsec을 우회하는 것이 허용된 트래픽의 경우 SA가 없다.)

### 아웃바운드 IP 패킷 처리절차

1. 패킷에 들어 있는 해당 필드(selector 필드) 값에 대응되는 SPD 엔트리를 찾기 위해 SPD와 비교
2. 패킷에 대한 SPD 엔트리와 연관된 SPI가 있다면 SA 결정
3. 필요한 IPsec 절차 처리
   - AH || ESP 처리 절차

cf) **selector**

- IP와 집합으로 정의되는 상위 계층의 프로토콜 필드 값으로 각 SPD 엔트리 결정
- 아웃바운드 트래픽을 특정 SA에 대응시키기 위한 selector는 트래픽 필터링에 사용
- Selector
  - 원격 IP 주소
  - 로컬 IP 주소
  - 다음 계층 프로토콜
  - 이름
  - 로컬과 원격 포트

### IP 트래픽 처리

- IPsec은 개별 패킷 기반으로 처리한다.
  - 아웃바운드 패킷
    - 아웃바운드 IP 패킷은 전송되기 전에 IPsec 로직에 의해 처리
  - 인바운드 패킷
    - 인바운드 패킷이 수신되면 다음 상위계층(TCP || UDP)로 패킷 내용을 전달하기 전에 IPsec로직에 의해 처리

### 아웃바운드 패킷 처리 모델

![1](https://user-images.githubusercontent.com/78394999/144238770-fa8ea5b6-c8aa-4df1-ae19-5b080d3c7c40.png)

### 인바운드 패킷 처리 모델

![2](https://user-images.githubusercontent.com/78394999/144238798-c175106c-7b95-49b5-ad14-a9975afef4c6.png)

### 캡슐화 보안 페이로드 (캡슐화 제공)

- 캡슐화 보안 페이로드(ES P)가 제공
  - 기밀성
  - 데이터 출처 인증
  - 비연결형 무결성
  - 재전송 방지 서비스(부분적 순서 무결성의 형태)
  - (제한된) 트래픽 흐름의 비밀성
- 다양한 암호화와 인증 알고리즘으로 동작

### 암호화 및 인증 알고리즘

- ESP 서비스에서 암호화 대상
  - 페이로드 데이터, 패딩, 패드 길이, 다음 헤더 필드

## 전송 모드 vs 터널 모드

![5](https://user-images.githubusercontent.com/78394999/144238848-611a956d-6b02-4c3f-ad51-419bd0f48544.png)
